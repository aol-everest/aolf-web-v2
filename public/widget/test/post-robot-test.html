<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>AOLF Auth Widget Test</title>
    <style>
        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f7f7f7;
            color: #333;
            -webkit-text-size-adjust: 100%;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        h1 {
            color: #333;
            margin-top: 0;
            font-size: 24px;
        }
        .buttons {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            touch-action: manipulation;
            min-height: 44px; /* Larger tap target for iOS */
        }
        button:hover {
            background: #0052a3;
        }
        pre {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 4px;
            overflow: auto;
            max-height: 300px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: Menlo, Monaco, Consolas, monospace;
            font-size: 13px;
            -webkit-overflow-scrolling: touch;
        }
        .device-info {
            background: #fff8e6;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #f2c037;
            font-size: 14px;
        }
        .iframe-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            background: #f5f5f5;
        }
        iframe {
            width: 100%;
            height: 300px;
            border: none;
        }
        .status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            background: #ccc;
        }
        .indicator.connected {
            background: #4caf50;
        }
        .indicator.warning {
            background: #ff9800;
        }
        .indicator.error {
            background: #f44336;
        }
        .advanced-options {
            margin-top: 15px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .advanced-options h3 {
            margin-top: 0;
            font-size: 16px;
        }
        .checkbox-group {
            margin-bottom: 10px;
        }
        .checkbox-group label {
            margin-left: 5px;
            font-size: 14px;
        }
        @media (max-width: 600px) {
            .buttons button {
                flex: 1 0 auto;
            }
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
            }
            pre {
                font-size: 11px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AOLF Auth Widget Test</h1>

        <div class="device-info" id="device-info">
            Loading device info...
        </div>

        <div class="status">
            <div class="indicator" id="status-indicator"></div>
            <span id="status-text">Initializing...</span>
        </div>

        <div class="buttons">
            <button id="load-iframe">Load Auth Iframe</button>
            <button id="request-auth">Request Auth Profile</button>
            <button id="clear-logs">Clear Log</button>
        </div>

        <div id="ios-buttons" style="display:none; margin-top:10px;">
            <div class="buttons">
                <button id="ios-fallback" style="background:#066;">iOS Fallback Load</button>
                <button id="check-status" style="background:#606;">Check Status</button>
            </div>
        </div>

        <pre id="log-output"></pre>

        <div class="advanced-options">
            <h3>Advanced Options</h3>
            <div class="checkbox-group">
                <input type="checkbox" id="debug-messages" checked>
                <label for="debug-messages">Show debug messages</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="auto-reconnect" checked>
                <label for="auto-reconnect">Auto-reconnect on error</label>
            </div>
            <div>
                <button id="load-debug-helper" style="background:#555;">Load Debug Helper</button>
            </div>
        </div>

        <div class="iframe-container" id="iframe-container">
            <!-- iframe will be loaded here -->
        </div>
    </div>

    <!-- Load post-robot script -->
    <script src="../post-robot.min.js"></script>

    <script>
        // Configuration
        const CONFIG = {
            widgetUrl: 'https://qa.members.us.artofliving.org/widget/auth-profile',
            debug: true,
            reconnectDelay: 1500,
            maxReconnectAttempts: 3
        };

        // Elements
        const logOutput = document.getElementById('log-output');
        const deviceInfo = document.getElementById('device-info');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const iframeContainer = document.getElementById('iframe-container');
        const iosButtonsContainer = document.getElementById('ios-buttons');

        // Checkboxes
        const debugMessagesCheckbox = document.getElementById('debug-messages');
        const autoReconnectCheckbox = document.getElementById('auto-reconnect');

        // Buttons
        const loadIframeBtn = document.getElementById('load-iframe');
        const requestAuthBtn = document.getElementById('request-auth');
        const clearLogsBtn = document.getElementById('clear-logs');
        const iosFallbackBtn = document.getElementById('ios-fallback');
        const checkStatusBtn = document.getElementById('check-status');
        const loadDebugHelperBtn = document.getElementById('load-debug-helper');

        // State
        let iframe = null;
        let authData = null;
        let reconnectAttempts = 0;
        let reconnectTimer = null;
        let communicationFailure = false;

        // Logger with verbosity control
        const logger = {
            log: function(message, alwaysShow = false) {
                console.log(message);
                if (debugMessagesCheckbox.checked || alwaysShow) {
                    logOutput.textContent += `[LOG] ${message}\n`;
                    logOutput.scrollTop = logOutput.scrollHeight;
                }
            },
            info: function(message, alwaysShow = false) {
                console.info(message);
                if (debugMessagesCheckbox.checked || alwaysShow) {
                    logOutput.textContent += `[INFO] ${message}\n`;
                    logOutput.scrollTop = logOutput.scrollHeight;
                }
            },
            warn: function(message) {
                console.warn(message);
                logOutput.textContent += `[WARN] ${message}\n`;
                logOutput.scrollTop = logOutput.scrollHeight;

                // Update status
                statusIndicator.className = 'indicator warning';
                statusText.textContent = 'Warning: ' + message;
            },
            error: function(message) {
                console.error(message);
                logOutput.textContent += `[ERROR] ${message}\n`;
                logOutput.scrollTop = logOutput.scrollHeight;

                // Update status
                statusIndicator.className = 'indicator error';
                statusText.textContent = 'Error: ' + message;

                if (autoReconnectCheckbox.checked && !communicationFailure) {
                    initiateReconnect();
                }
            },
            clear: function() {
                logOutput.textContent = '';
            },
            highlight: function(message) {
                console.log('%c' + message, 'background: #404; color: white; padding: 2px 5px;');
                logOutput.textContent += `[✨] ${message}\n`;
                logOutput.scrollTop = logOutput.scrollHeight;
            }
        };

        // Enhanced device detection with iOS version
        function detectDevice() {
            const ua = navigator.userAgent;
            const isIOS = /iPhone|iPad|iPod|iOS|CriOS/.test(ua) ||
                        (/Safari/.test(ua) && /Apple/.test(navigator.vendor) && !/Chrome|Android/.test(ua)) ||
                        (/Macintosh/.test(ua) && navigator.maxTouchPoints > 1);
            const isMobile = /Mobi|Android|iPhone|iPad|iPod/.test(ua);
            const browser =
                /Chrome/.test(ua) && !/Edge|Edg/.test(ua) ? 'Chrome' :
                /Safari/.test(ua) && !/Chrome|Android/.test(ua) ? 'Safari' :
                /Firefox/.test(ua) ? 'Firefox' :
                /Edge|Edg/.test(ua) ? 'Edge' : 'Other';

            // Extract iOS version if applicable
            let iosVersion = 'N/A';
            if (isIOS) {
                const match = ua.match(/OS (\d+)_(\d+)_?(\d+)?/);
                iosVersion = match ? match[1] + '.' + match[2] + (match[3] ? '.' + match[3] : '') : 'Unknown';
            }

            const isIOSSafari = isIOS && /Safari/.test(ua) && !/Chrome|CriOS/.test(ua);

            deviceInfo.innerHTML = `
                <strong>Device:</strong> ${isIOS ? '📱 iOS' : isMobile ? '📱 Mobile' : '💻 Desktop'}<br>
                <strong>Browser:</strong> ${browser}${isIOS ? ` (iOS ${iosVersion})` : ''}<br>
                <strong>PostRobot:</strong> ${window.postRobot ? '✅ Loaded' : '❌ Not Loaded'}<br>
                <strong>User Agent:</strong> <span style="font-size:11px;">${ua.substring(0, 100)}...</span>
            `;

            // Show iOS-specific buttons
            iosButtonsContainer.style.display = isIOS ? 'block' : 'none';

            return {
                isIOS,
                isMobile,
                browser,
                userAgent: ua,
                iosVersion,
                isIOSSafari,
                isKnownProblematicIOS: isIOS && parseInt(iosVersion) < 15
            };
        }

        // Initiate a reconnection attempt
        function initiateReconnect() {
            if (reconnectAttempts >= CONFIG.maxReconnectAttempts) {
                communicationFailure = true;
                logger.error(`Maximum reconnect attempts (${CONFIG.maxReconnectAttempts}) reached. Manual intervention required.`);
                return;
            }

            reconnectAttempts++;
            logger.warn(`Communication issue detected. Reconnect attempt ${reconnectAttempts}/${CONFIG.maxReconnectAttempts} in ${CONFIG.reconnectDelay/1000}s...`);

            clearTimeout(reconnectTimer);
            reconnectTimer = setTimeout(() => {
                logger.highlight("Attempting to re-establish connection...");
                loadIframe();
            }, CONFIG.reconnectDelay);
        }

        // Reset reconnection state
        function resetReconnectState() {
            reconnectAttempts = 0;
            communicationFailure = false;
            clearTimeout(reconnectTimer);
        }

        // Load iframe with enhanced error handling
        function loadIframe() {
            // Clear existing iframe
            iframeContainer.innerHTML = '';

            // Reset connection state
            resetReconnectState();

            // Create and add debug parameters
            const device = detectDevice();
            const clientOrigin = encodeURIComponent(window.location.origin);
            const debugParam = CONFIG.debug ? '&debug=true' : '';
            const parentParam = `&client=${clientOrigin}`;
            const timestamp = `&t=${Date.now()}`;
            const deviceParam = `&device=${device.isIOS ? 'ios' : 'other'}`;

            // Create iframe
            iframe = document.createElement('iframe');
            iframe.id = 'auth-profile-iframe';

            // Add additional attributes for iOS
            if (device.isIOS) {
                iframe.setAttribute('webkit-playsinline', 'true');
                iframe.setAttribute('playsinline', 'true');
            }

            iframe.src = `${CONFIG.widgetUrl}?${parentParam}${debugParam}${timestamp}${deviceParam}`;

            // Add load and error event handlers
            iframe.onload = () => {
                logger.info('Iframe loaded', true);
                statusText.textContent = 'Iframe loaded, establishing connection...';
            };

            iframe.onerror = () => {
                logger.error('Iframe failed to load');
            };

            // Add to container
            iframeContainer.appendChild(iframe);

            // Update status
            statusIndicator.className = 'indicator';
            statusText.textContent = 'Loading iframe...';

            logger.info(`Loaded iframe with URL: ${iframe.src}`, true);

            // Set up post-robot listeners with cancellation of previous ones
            setupListeners();
        }

        // iOS-specific fallback loading method
        function loadIframeIOSFallback() {
            logger.highlight('Using iOS fallback loading method');

            // Clear existing iframe
            iframeContainer.innerHTML = '';

            // Reset connection state
            resetReconnectState();

            const device = detectDevice();
            const clientOrigin = encodeURIComponent(window.location.origin);
            const debugParam = CONFIG.debug ? '&debug=true' : '';
            const parentParam = `&client=${clientOrigin}`;
            const timestamp = `&t=${Date.now()}`;
            const iosParam = '&platform=ios';

            const src = `${CONFIG.widgetUrl}?${parentParam}${debugParam}${timestamp}${iosParam}`;

            // Use document.write for older iOS versions
            const iframeHtml = `
                <iframe id="auth-profile-iframe"
                        src="${src}"
                        width="100%"
                        height="300px"
                        frameborder="0"
                        webkit-playsinline="true"
                        playsinline="true"></iframe>
            `;

            // Create a temporary div and set its innerHTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = iframeHtml;

            // Replace the container contents with the new iframe
            iframeContainer.appendChild(tempDiv.firstElementChild);

            // Get a reference to the new iframe
            iframe = document.getElementById('auth-profile-iframe');

            // Update status
            statusIndicator.className = 'indicator';
            statusText.textContent = 'Loading iframe (iOS fallback)...';

            logger.info(`Loaded iframe with URL: ${src} (iOS fallback method)`, true);

            // Set up post-robot listeners
            setupListeners();
        }

        // Set up post-robot listeners with cancellation of previous ones
        function setupListeners() {
            // Listen for auth profile updates
            const authUpdateListener = postRobot.on('auth-widget-data-updated', event => {
                authData = event.data;
                logger.info(`Received auth update: Authenticated: ${authData.isAuthenticated}`, true);
                logger.log(`Platform: ${authData.platform || 'not specified'}`);

                if (authData.profile) {
                    logger.info(`Profile: ${authData.profile.first_name} ${authData.profile.last_name}`);
                }

                // Update status
                statusIndicator.className = 'indicator connected';
                statusText.textContent = authData.isAuthenticated ?
                    `Authenticated as ${authData.profile?.first_name || 'User'}` :
                    'Not authenticated';

                // Reset reconnect state since we have successful communication
                resetReconnectState();
            });

            // Listen for ready messages
            const readyListener = postRobot.on('auth-widget-ready', event => {
                logger.info('Widget is ready', true);
                logger.log(`Platform reported by widget: ${event.data.platform || 'not specified'}`);

                statusIndicator.className = 'indicator connected';
                statusText.textContent = 'Widget connected';

                // Auto-request auth when widget is ready
                requestAuthProfile();

                // Reset reconnect state
                resetReconnectState();
            });

            // Store listeners for cleanup
            window.currentListeners = {
                authUpdate: authUpdateListener,
                ready: readyListener
            };
        }

        // Clean up listeners
        function cleanupListeners() {
            if (window.currentListeners) {
                try {
                    if (window.currentListeners.authUpdate) {
                        window.currentListeners.authUpdate.cancel();
                    }
                    if (window.currentListeners.ready) {
                        window.currentListeners.ready.cancel();
                    }
                    logger.log('Cleaned up previous listeners');
                } catch (err) {
                    logger.error('Error cleaning up listeners: ' + err.message);
                }
            }
        }

        // Request auth profile with better error handling
        function requestAuthProfile() {
            if (!iframe || !iframe.contentWindow) {
                logger.error('Iframe not available');
                return;
            }

            try {
                logger.info('Requesting auth profile...', true);

                postRobot.send(iframe.contentWindow, 'get-auth-profile')
                    .then(event => {
                        authData = event.data;
                        logger.info(`Auth profile received: Authenticated: ${authData.isAuthenticated}`, true);

                        if (authData.profile) {
                            logger.info(`Name: ${authData.profile.first_name} ${authData.profile.last_name}`);
                            logger.info(`Email: ${authData.profile.email || 'N/A'}`);
                        }

                        if (authData.tokens) {
                            logger.info(`Tokens: Present (${authData.tokens.accessToken ? 'Access Token' : ''} ${authData.tokens.idToken ? 'ID Token' : ''})`);
                        }

                        logger.log(`Platform: ${authData.platform || 'not specified'}`);

                        // Update status
                        statusIndicator.className = 'indicator connected';
                        statusText.textContent = authData.isAuthenticated ?
                            `Authenticated as ${authData.profile?.first_name || 'User'}` :
                            'Not authenticated';

                        // Reset reconnect state on successful communication
                        resetReconnectState();
                    })
                    .catch(err => {
                        logger.error(`Auth request failed: ${err.message || err}`);
                    });
            } catch (err) {
                logger.error(`Error sending auth request: ${err.message || err}`);
            }
        }

        // Check communication status
        function checkStatus() {
            logger.highlight('Checking communication status...');

            if (!iframe) {
                logger.error('No iframe available to check status');
                return;
            }

            if (!iframe.contentWindow) {
                logger.error('Iframe contentWindow not accessible - potential security restriction');
                return;
            }

            try {
                // Try to ping the iframe
                postRobot.send(iframe.contentWindow, 'get-auth-profile')
                    .then(() => {
                        logger.highlight('✅ Communication check successful!');
                        statusIndicator.className = 'indicator connected';
                        statusText.textContent = 'Communication verified';
                    })
                    .catch(err => {
                        logger.error(`Communication check failed: ${err.message || err}`);
                    });
            } catch (err) {
                logger.error(`Error checking status: ${err.message || err}`);
            }
        }

        // Load debug helper
        function loadDebugHelper() {
            logger.info('Loading debug helper...', true);

            const existingScript = document.getElementById('debug-helper-script');
            if (existingScript) {
                logger.warn('Debug helper already loaded');
                return;
            }

            const script = document.createElement('script');
            script.id = 'debug-helper-script';
            script.src = '../debug-helper.js?' + Date.now();
            script.onload = () => {
                logger.highlight('Debug helper loaded successfully');
            };
            script.onerror = (err) => {
                logger.error('Failed to load debug helper: ' + err);
            };

            document.head.appendChild(script);
        }

        // Event listeners
        loadIframeBtn.addEventListener('click', loadIframe);
        requestAuthBtn.addEventListener('click', requestAuthProfile);
        clearLogsBtn.addEventListener('click', logger.clear);
        iosFallbackBtn.addEventListener('click', loadIframeIOSFallback);
        checkStatusBtn.addEventListener('click', checkStatus);
        loadDebugHelperBtn.addEventListener('click', loadDebugHelper);

        // Checkbox event listeners
        debugMessagesCheckbox.addEventListener('change', () => {
            if (debugMessagesCheckbox.checked) {
                logger.highlight('Debug messages enabled');
            } else {
                logger.highlight('Debug messages disabled (only errors and highlights shown)');
            }
        });

        autoReconnectCheckbox.addEventListener('change', () => {
            if (autoReconnectCheckbox.checked) {
                logger.info('Auto-reconnect enabled', true);
            } else {
                logger.info('Auto-reconnect disabled', true);
                clearTimeout(reconnectTimer);
            }
        });

        // Initialize
        const device = detectDevice();
        if (device.isKnownProblematicIOS) {
            logger.warn(`iOS ${device.iosVersion} detected. This version may have known communication issues.`);
        }

        logger.info('Test page initialized', true);
        loadIframe();
    </script>
</body>
</html>
